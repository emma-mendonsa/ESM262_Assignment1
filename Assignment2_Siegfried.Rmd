---
title: "ESM 262: Assignment 2"
author: "Emma Siegfried"
date: "May 18, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

###SetUp
Library:
``` {r message=FALSE}

library(tidyverse)
library(lubridate)
library(knitr)
library(kableExtra)
library(dplyr)
library(DBI)

```


###Import and Tidy

1. Read the gazetteer data as-is (all columns; no type conversion) into a gaz_raw tibble. 
  
2. Copy only specified columns into a gaz tibble.
  
``` {r results='hide', message=FALSE}

#Raw Dataset:
gaz_raw <- read_delim("CA_Features_20180401.txt", delim = "|")

#class(gaz_raw) #confirmed this is a tibble


#Subset data
gaz <- gaz_raw %>% 
  select(FEATURE_NAME, FEATURE_CLASS, STATE_ALPHA, COUNTY_NAME, 
         PRIM_LAT_DEC, PRIM_LONG_DEC)

```
  
3. Convert columns to appropriate type. Convert placeholders for unknown data to NA
 
4. Delete rows with: primary latitude and longitude unknown; and if not in California
   
*Tidy Dataset:*
```{r results='hide'}

gaz <- gaz %>% 
  filter(STATE_ALPHA == "CA") %>% 
  filter(PRIM_LAT_DEC != "NA") %>% 
  filter(PRIM_LONG_DEC != "NA")

```
   




```{r}


con <- DBI::dbConnect(RSQLite::SQLite(), path = ":memory:")

copy_to(con, gaz, "gaz",
        temporary = FALSE, 
        overwrite = TRUE, 
        indexes = list(
         "FEATURE_NAME"
        ))

#Create a table cookie that connects to the database

gaz_db <- tbl(con, "gaz")

```
###Analyze and Answer

**Q1. What is the most frequently occurring feature name?**
```{r}

count_names_max <- dbGetQuery(con, 
                          "SELECT FEATURE_NAME, COUNT() AS n 
                          FROM gaz GROUP BY FEATURE_NAME
                          ORDER BY n DESC")

head(count_names_max)

```
**Answer:** Church of Christ appears the most with 228 listings

---

**Q2. What is the least-frequently occurring feature class?**
```{r}

count_class_min <- dbGetQuery(con,
                            "SELECT FEATURE_CLASS, COUNT() AS n
                            FROM gaz
                            GROUP BY FEATURE_CLASS
                            ORDER BY n")

head(count_class_min)

```
**Answer:** Sea and Isthum appear the least with 1 listing each.

---

**Q3. What is the approximate center point of each count?**

```{r}

gaz_centers <- dbGetQuery(con, 
        "SELECT COUNTY_NAME AS County, 
                Center_Latitude, Center_Latitude 
         FROM (SELECT COUNTY_NAME, 
                AVG(PRIM_LONG_DEC) AS Center_Longitude,
                AVG (PRIM_LAT_DEC) AS Center_Latitude 
         FROM gaz
         GROUP BY COUNTY_NAME)")

head(gaz_centers)

```

**Answer**: County centers are listed in the gaz_centers query.

---

**Q4. What are the fractions of the total number of features in each county that are natural vs. manmade?**

```{r}

#Import Offical Feature Class Dataset:
features_raw <- read_csv("Class_Code_Definitions.csv") %>% 
  select(1,2) %>% 
  rename(FEATURE_CLASS = Class)

#Create Combo Tibble
class_combo <- as.tibble(count_class_min) #made tibble

class_combo <- class_combo %>% 
  full_join(features_raw, by = "FEATURE_CLASS") %>%  #join Offical Features to Gaz Features
  arrange(-desc(FEATURE_CLASS))

#Copy into Database & Wrote out Table

copy_to(con, class_combo, "class_combo",
        temporary = FALSE, 
        overwrite = TRUE)


#Join Official and Gaz class types

gaz_class <- dbGetQuery(con, 
     "SELECT gaz.FEATURE_NAME, gaz.FEATURE_CLASS, gaz.COUNTY_NAME, 
class_combo.FEATURE_CLASS, class_combo.Type
      FROM gaz JOIN class_combo
      ON gaz.FEATURE_CLASS = class_combo.FEATURE_CLASS")


head(gaz_class)

#Save this table to database
copy_to(con, gaz_class, "gaz_class",
        temporary = FALSE, 
        overwrite = TRUE)

gaz_db_class <- tbl(con, "gaz_class")

```

Find Manmade & Natural fractions per County
```{r}

#Create Table of Feature Counts per County

gaz_class <- dbGetQuery(con,
     "SELECT COUNTY_NAME, 
      SUM(Type = 'M') AS Manmade_Per_County,
      SUM(Type = 'N') AS Natural_Per_County,
      COUNT(Type) AS Total_Per_County,
      CAST(SUM(Type = 'M') AS REAL)/COUNT(Type) 
          AS Fraction_Manmade,
      CAST(SUM(Type = 'N') AS REAL)/COUNT(Type) 
          AS Fraction_Natural
      FROM gaz_class
      GROUP BY County_Name")

head(gaz_class)

```






